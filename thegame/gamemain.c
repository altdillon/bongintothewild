
// include NESLIB header
#include <string.h>
#include "./../neslib/neslib.h"
#include "pallets.h"
#include "gameconfig.h"
#include "player.h"
#include "scrolling.h"
#include "vrambuf.h"

// function to write a string into the name table
//   adr = start address in name table
//   str = pointer to string
void put_str(unsigned int adr, const char *str);

void setup_graphics();
void move_player(player_t *player);
void play_state();
void title_screen();
void show_title_screen(const byte* pal, const byte* rle);

const byte hello_palette[16]={ 0x0f,0x00,0x10,0x30,0x0f,0x01,0x21,0x31,0x0f,0x06,0x16,0x26,0x0f,0x09,0x19,0x29 };


const byte hello_rle[] = {
0x01, 0x05, 0x01, 0x20, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x03, 0x03, 0x01, 0x0F, 0x00, 0x01,
0x09, 0x05, 0x05, 0x00, 0x01, 0x03, 0x03, 0x00, 0x00, 0x54, 0x49, 0x54, 0x4C, 0x45, 0x00, 0x01, 0x06, 0x03, 0x00, 0x01, 0x09, 0x05, 0x05, 0x00, 0x01, 0x03, 0x03, 0x00, 0x01, 0x0D, 0x03, 0x00,
0x01, 0x09, 0x05, 0x05, 0x00, 0x01, 0x03, 0x03, 0x00, 0x01, 0x06, 0x53, 0x63, 0x52, 0x45, 0x45, 0x4E, 0x00, 0x03, 0x00, 0x01, 0x09, 0x05, 0x05, 0x00, 0x01, 0x03, 0x03, 0x01, 0x0F, 0x00, 0x01,
0x09, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x07, 0x96, 0x01, 0x06, 0x00, 0x01, 0x0E, 0x05, 0x05, 0x00, 0x01, 0x06, 0x96, 0x01, 0x05, 0x00, 0x00, 0x96, 0x00, 0x01, 0x0D, 0x05,
0x05, 0x00, 0x01, 0x05, 0x96, 0x96, 0x00, 0x01, 0x06, 0x96, 0x96, 0x00, 0x01, 0x0C, 0x05, 0x05, 0x00, 0x01, 0x05, 0x96, 0x96, 0x00, 0x53, 0x54, 0x41, 0x52, 0x54, 0x00, 0x96, 0x96, 0x00, 0x01,
0x0C, 0x05, 0x05, 0x00, 0x01, 0x06, 0x96, 0x00, 0x01, 0x05, 0x96, 0x96, 0x00, 0x01, 0x0D, 0x05, 0x05, 0x00, 0x01, 0x06, 0x96, 0x96, 0x00, 0x01, 0x02, 0x96, 0x01, 0x02, 0x00, 0x01, 0x0E, 0x05,
0x05, 0x00, 0x01, 0x07, 0x96, 0x01, 0x04, 0x00, 0x01, 0x10, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05,
0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01, 0x1D, 0x05, 0x05, 0x00, 0x01,
0x1D, 0x05, 0x01, 0x1F, 0x05, 0x01, 0x00 
};


// main function, run after console reset
void main(void)
{
  gamestate_t gamestate;
  gamestate = TITLESCREEN;

  while(1)
  {
    switch (gamestate)
    {
    case GAMETIME:
      play_state();
      break;
  
    case TITLESCREEN:
      title_screen();
      gamestate = GAMETIME;
      break;

    default:
      break;
    }
 
  }
}

void show_title_screen(const byte* pal, const byte* rle)
{
  ppu_off();

  pal_bg(pal);
  pal_bright(4);
  vram_adr(0x2000);
  vram_unrle(rle);
  ppu_on_all();
}

void title_screen()
{
    char i, start_btn = 0, pad;

    show_title_screen(hello_palette, hello_rle);

    // wait for start button
    while(start_btn != 1) {
        for(i = 0; i < 2; i++) {
            pad = pad_poll(i);
            if(pad & PAD_START) start_btn = 1;
        }
        ppu_wait_nmi(); // wait for next frame
    }

    // clear screen before moving on
    ppu_off();
    vram_adr(NAMETABLE_A);
    vram_fill(0x00, 960);
    vram_fill(0x00, 64);
    ppu_on_all();
    ppu_off();
}

// void title_screen()
// {
//   //show_title_screen(game_title_pal,game_title_pal);
//   /*
//     quick and dirty title screen 
//   */
//   char i;
//   char start_btn;
//   char pad;
//   pal_col(0,0x03);	// set screen to dark blue
//   pal_col(1,0x14);	// fuchsia
//   pal_col(2,0x20);	// grey
//   pal_col(3,0x2d);
//   put_str(NTADR_A(2,6), "PRESS START!");
//   ppu_on_all();

//   //show_title_screen(hello_palette,hello_rle);

//   start_btn = 0;
//   while(start_btn != 1)
//   {
//     for(i=0;i<2;i++)
//     {
//       pad = pad_poll(i);
//       if(pad&PAD_START) // if the start button was indeed pressed
//       {
//         start_btn = 1;
//       }
//     }
//   }
//   ppu_off();
//   vram_adr(NAMETABLE_A);
//   vram_fill(0x00, 960);   // clear tiles
//   vram_fill(0x00, 64);    // clear attributes
//   ppu_on_all();
//   ppu_off();
// }

/*
  function for the game play state
*/
void play_state()
{
  char running;
  player_t player; // player object
  scroll_t scroller;
  //Window_t window; // location of the window

  running = 1;
  // init the player
  player.px = 120;
  player.py = 120;
  player.dx = 3;
  player.dy = 3;
  player.ctrlr = 0;
  player.playerSp = 0xB1;

  // init the scroller
  scroller.sx = 0;
  scroller.sy = 0;

  // write text to name table
  put_str(NTADR_A(2,0), "Nametable A, Line 0");
  put_str(NTADR_A(2,15), "Nametable A, Line 15");
  put_str(NTADR_A(2,29),"Nametable A, Line 29");
  put_str(NTADR_C(2,0), "Nametable C, Line 0");
  put_str(NTADR_C(2,15), "Nametable C, Line 15");
  put_str(NTADR_C(2,29),"Nametable C, Line 29");

  setup_graphics();
  while(running)
  {
    oam_clear();
    oam_spr(player.px, player.py, player.playerSp, 0,0);
    ppu_wait_nmi();

    // update player from the controller
    move_player(&player);
    // figure out if we have to scroll
    // scroll if we need to
    //map_scroll(scroll_t *scroll, player_t *player, char ncontroller)
    map_scroll(&scroller,&player,0);
    scroll(scroller.sx,scroller.sy);
  }
}

void setup_graphics()
{
  // clear the sprites and turn on the ppu
  oam_clear();
  // set palette colors
  pal_all(PALETTE);
  // turn on PPU
  ppu_on_all();
}

void put_str(unsigned int adr, const char *str) 
{
  vram_adr(adr);        // set PPU read/write address
  vram_write(str, strlen(str)); // write bytes to PPU
}